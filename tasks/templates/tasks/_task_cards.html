{% load i18n %}
{% if tasks %}
  {% for task in tasks %}
  <div class="card mb-3">
    <div class="card-body py-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="flex-grow-1 me-3">
          <h3 class="h6 mb-0">
            <a class="text-break text-decoration-none" href="{% url 'tasks:detail' task.pk %}">{{ task.title }}</a>
            {% if task.chat_room_url %}
              <a href="{{ task.chat_room_url }}" target="_blank" class="text-decoration-none ms-3 {{ task.chat_room_pulse_class }}">
                <i class="bi bi-chat-dots" style="font-size: 1.1em;"></i>
              </a>
            {% endif %}
          </h3>
        </div>
        {% if show_status %}
          {% if task.status == task.Status.COMPLETED %}
            <span class="badge bg-success text-uppercase">{{ task.get_status_display }}</span>
          {% elif task.status == task.Status.CANCELLED %}
            <span class="badge bg-secondary text-uppercase">{{ task.get_status_display }}</span>
          {% elif task.status == task.Status.REJECTED %}
            <span class="badge bg-dark text-uppercase">{{ task.get_status_display }}</span>
          {% else %}
            <span class="badge bg-info text-dark text-uppercase">{{ task.get_status_display }}</span>
          {% endif %}
        {% elif task.priority_label %}
          {% with task.priority_category as category %}
            {% if category == "critical" %}
              <span class="badge bg-danger text-uppercase">{{ task.priority_label }}</span>
            {% elif category == "important" %}
              <span class="badge bg-warning text-dark text-uppercase">{{ task.priority_label }}</span>
            {% elif category == "beneficial" %}
              <span class="badge bg-success text-uppercase">{{ task.priority_label }}</span>
            {% elif category == "rejected" %}
              <span class="badge bg-secondary text-uppercase">{{ task.priority_label }}</span>
            {% else %}
              <span class="badge bg-info text-dark text-uppercase">{{ task.priority_label }}</span>
            {% endif %}
          {% endwith %}
        {% endif %}
      </div>

      <div class="d-flex justify-content-between align-items-center mb-2">
        <p class="small text-muted mb-0 pe-3 text-break" style="display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">{{ task.description|linebreaksbr|truncatechars_html:150|safe }}</p>
        {% if show_take_button %}
          {% if task.assigned_to == request.user %}
            <form method="post" action="{% url 'tasks:resign' task.pk %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">{% trans "Resign" %}</button>
            </form>
          {% else %}
            <form method="post" action="{% url 'tasks:take' task.pk %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button class="btn btn-sm btn-outline-primary" type="submit">{% trans "Take task" %}</button>
            </form>
          {% endif %}
        {% endif %}
      </div>

      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 small text-muted border-top pt-2">
        <span>{% trans "Votes" %}: {{ task.votes_score|default:0 }} | {% trans "Owner" %}: {{ task.assigned_to|default:_("n/a") }}</span>
      </div>
    </div>
  </div>
  {% endfor %}
{% else %}
  <p class="text-muted fst-italic">{{ empty_message }}</p>
{% endif %}
